<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="null" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="dc7b0c46-150c-4cf8-9705-4200971791b2">
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="fecha_desde" class="java.util.Date">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="fecha_hasta" class="java.util.Date">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="id_producto" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT 
    v.numero, 
    to_char(v.fecha, 'dd-mm-yyyy') AS fecha_formateada, 
    p.descripcion, 
    dt.precio, 
    dt.cantidad, 
    SUM(v.total) OVER () AS suma_total_compras,  -- Suma total de todas las compras en el rango de fechas
    
    -- Incluir las fechas 'Desde' y 'Hasta' como parámetros dinámicos
    to_char($P{fecha_desde}::date, 'DD-MM-YYYY') AS fecha_desde, 
    to_char($P{fecha_hasta}::date, 'DD-MM-YYYY') AS fecha_hasta

FROM 
    detallecompras dt
JOIN 
    productos p ON dt.id_producto = p.id_producto 
JOIN 
    compras v ON dt.idcompra = v.id 
WHERE 
    v.estado = 'Finalizado' 
    AND v.fecha BETWEEN $P{fecha_desde}::date AND $P{fecha_hasta}::date 
    AND dt.id_producto = $P{id_producto}  -- Filtro por producto
ORDER BY 
    v.fecha;
]]>
	</queryString>
	<field name="numero" class="java.lang.Integer"/>
	<field name="fecha_formateada" class="java.lang.String"/>
	<field name="descripcion" class="java.lang.String"/>
	<field name="precio" class="java.lang.Integer"/>
	<field name="cantidad" class="java.lang.Integer"/>
	<field name="suma_total_compras" class="java.lang.Long"/>
	<field name="fecha_desde" class="java.lang.String"/>
	<field name="fecha_hasta" class="java.lang.String"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="102" splitType="Stretch">
			<textField>
				<reportElement x="127" y="75" width="100" height="20" uuid="f0b301ca-1dcc-4d0a-b66d-0beebdd9db9d"/>
				<textFieldExpression><![CDATA[$F{fecha_desde}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="234" y="75" width="100" height="20" uuid="825c558d-38e9-4b3f-bb45-41ef7c7d24ed"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[FECHA FIN]]></text>
			</staticText>
			<staticText>
				<reportElement x="1" y="10" width="555" height="65" uuid="f93f39ae-b77d-498c-9111-eeb6df25bf8b"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Century Gothic" size="24" isBold="true"/>
				</textElement>
				<text><![CDATA[INFORME  DETALLE PRODUCTOS]]></text>
			</staticText>
			<textField>
				<reportElement x="334" y="75" width="100" height="20" uuid="6f845558-9315-4c27-b2f8-10eff183e345"/>
				<textFieldExpression><![CDATA[$F{fecha_hasta}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="36" y="75" width="100" height="20" uuid="2e4a4cbe-4dc9-47f4-adb3-28b386bd2e24"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[FECHA INICIO]]></text>
			</staticText>
		</band>
	</title>
	<columnHeader>
		<band height="36" splitType="Stretch">
			<rectangle>
				<reportElement x="0" y="2" width="555" height="32" uuid="8a621284-c0ef-4363-a750-5269932085eb"/>
			</rectangle>
			<staticText>
				<reportElement x="465" y="2" width="52" height="32" uuid="4b05368a-e12d-433e-971e-30203b9b9f74"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Century Gothic" isBold="true"/>
				</textElement>
				<text><![CDATA[PRECIO]]></text>
			</staticText>
			<staticText>
				<reportElement x="341" y="2" width="100" height="32" uuid="43df62b3-84bf-481d-9c0c-58f27c191041"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Century Gothic" isBold="true"/>
				</textElement>
				<text><![CDATA[CANTIDAD]]></text>
			</staticText>
			<staticText>
				<reportElement x="20" y="2" width="31" height="32" uuid="48e92c5d-b7b8-422d-89ab-c064bfa85b81"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Century Gothic" isBold="true"/>
				</textElement>
				<text><![CDATA[COD]]></text>
			</staticText>
			<staticText>
				<reportElement x="91" y="2" width="60" height="32" uuid="7e5b3838-0776-4d15-8b25-4bd318bb80aa"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Century Gothic" isBold="true"/>
				</textElement>
				<text><![CDATA[FECHA]]></text>
			</staticText>
			<staticText>
				<reportElement x="202" y="4" width="100" height="32" uuid="f3ca83de-e309-46e9-827e-13149a824216"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="Century Gothic" isBold="true"/>
				</textElement>
				<text><![CDATA[PRODUCTO]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="39" splitType="Stretch">
			<rectangle>
				<reportElement x="0" y="3" width="555" height="32" uuid="96272d4e-ceca-40bd-b0b3-23b176b6ea65"/>
			</rectangle>
			<textField>
				<reportElement x="24" y="3" width="30" height="33" uuid="56b7cb35-198e-4623-bcd1-71e0f69a0949"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{numero}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="344" y="3" width="100" height="32" uuid="b322187f-a9fe-4359-b4ad-0ef98d77d41c"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{cantidad}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="192" y="3" width="152" height="35" uuid="8f1ab406-abeb-4252-9ddf-52c5742215fa"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{descripcion}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="465" y="3" width="90" height="30" uuid="aef246cb-37c5-49e9-aa4b-e196b61b3957"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{precio}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="79" y="3" width="100" height="32" uuid="678738ab-f896-48c6-9592-27a0e8b8f660"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{fecha_formateada}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<summary>
		<band height="42" splitType="Stretch">
			<rectangle>
				<reportElement x="455" y="0" width="100" height="20" uuid="7d8d807b-6550-4890-bc7e-491a8a71ed62"/>
			</rectangle>
			<textField>
				<reportElement x="455" y="0" width="100" height="20" uuid="aa1004b5-d296-4ad1-b091-f222bfd00cf3"/>
				<textFieldExpression><![CDATA[$F{suma_total_compras}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>

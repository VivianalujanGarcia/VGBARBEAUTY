<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="null" language="groovy"
              pageWidth="595" pageHeight="842"
              columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20"
              uuid="2bb73236-cd01-4bd0-a346-70e1ad4bc267">
    <property name="ireport.zoom" value="1.0"/>
    <property name="ireport.x" value="0"/>
    <property name="ireport.y" value="0"/>

    <!-- Parámetro idventa -->
    <parameter name="idventa" class="java.lang.Integer">
        <defaultValueExpression><![CDATA[1]]></defaultValueExpression> <!-- Asigna un valor por defecto -->
    </parameter>

    <!-- Consulta SQL -->
    <queryString>
        <![CDATA[
        WITH detalles_venta AS (
            SELECT
                dv.idventa AS detalleventas_idventa,
                dv.id_producto AS detalleventas_idproductos,
                dv.precio AS detalleventas_det_precio,
                dv.cantidad AS detalleventas_det_cantidad,
                p.id_producto AS productos_idproductos,
                p.nombre AS productos_pro_nombre,
                p.iva AS productos_iva,
                CASE 
                    WHEN p.iva = 0 THEN dv.precio * dv.cantidad
                    ELSE 0  
                END AS exenta,
                CASE 
                    WHEN p.iva = 5 THEN dv.precio * dv.cantidad
                    ELSE 0  
                END AS cinco,
                CASE 
                    WHEN p.iva = 10 THEN dv.precio * dv.cantidad
                    ELSE 0  
                END AS diez,
                CASE 
                    WHEN p.iva = 5 THEN dv.precio * dv.cantidad / 22
                    ELSE 0
                END AS liq_total_iva_5,
                CASE 
                    WHEN p.iva = 10 THEN dv.precio * dv.cantidad / 11
                    ELSE 0
                END AS liq_total_iva_10,
                CASE 
                    WHEN p.iva = 5 THEN dv.precio * dv.cantidad / 22
                    WHEN p.iva = 10 THEN dv.precio * dv.cantidad / 11
                    ELSE 0
                END AS total_iva
            FROM
                productos p 
            INNER JOIN 
                detalleventas dv 
                ON p.id_producto = dv.id_producto
            WHERE 
                dv.idventa = ?
        )
        SELECT
            SUM(total_linea) AS total_general,
            SUM(cinco) AS total_iva_5,
            SUM(diez) AS total_iva_10,
            SUM(total_iva) AS subtotal_iva,
            SUM(liq_total_iva_5) AS liq_total_iva_5,
            SUM(liq_total_iva_10) AS liq_total_iva_10,
            TO_CHAR(SUM(total_linea), '999,999,999') AS total_en_letras
        FROM (
            SELECT
                dv.precio * dv.cantidad AS total_linea,
                CASE 
                    WHEN p.iva = 5 THEN dv.precio * dv.cantidad
                    ELSE 0
                END AS cinco,
                CASE 
                    WHEN p.iva = 10 THEN dv.precio * dv.cantidad
                    ELSE 0
                END AS diez,
                CASE 
                    WHEN p.iva = 0 THEN 0
                    WHEN p.iva = 5 THEN dv.precio * dv.cantidad / 22
                    WHEN p.iva = 10 THEN dv.precio * dv.cantidad / 11
                    ELSE 0
                END AS total_iva,
                CASE 
                    WHEN p.iva = 5 THEN dv.precio * dv.cantidad / 22
                    ELSE 0
                END AS liq_total_iva_5,
                CASE 
                    WHEN p.iva = 10 THEN dv.precio * dv.cantidad / 11
                    ELSE 0
                END AS liq_total_iva_10
            FROM
                productos p 
            INNER JOIN 
                detalleventas dv 
                ON p.id_producto = dv.id_producto
            WHERE 
                dv.idventa = ?
        ) subquery;
        ]]>
    </queryString>

    <!-- Definición de campos -->
    <field name="total_general" class="java.lang.Long"/>
    <field name="total_iva_5" class="java.lang.Long"/>
    <field name="total_iva_10" class="java.lang.Long"/>
    <field name="subtotal_iva" class="java.lang.Long"/>
    <field name="liq_total_iva_5" class="java.lang.Long"/>
    <field name="liq_total_iva_10" class="java.lang.Long"/>
    <field name="total_en_letras" class="java.lang.String"/>

    <!-- Detalles del informe -->
    <background>
        <band splitType="Stretch"/>
    </background>

    <detail>
        <band height="125" splitType="Stretch">
            <textField>
                <reportElement x="98" y="20" width="287" height="20" uuid="68de492c-3cf5-4519-a77d-3a71d45d42c0"/>
                <textFieldExpression><![CDATA[$F{total_en_letras}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="307" y="40" width="78" height="20" uuid="ee24ba63-b92b-43e3-8576-74960a7216fc"/>
                <textFieldExpression><![CDATA[$F{subtotal_iva}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="459" y="1" width="52" height="20" uuid="c6af0417-8e11-442e-b0af-52a30690a058"/>
                <textFieldExpression><![CDATA[$F{total_iva_5}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="511" y="1" width="44" height="20" uuid="454c4892-2435-41de-8825-16368b5228da"/>
                <textFieldExpression><![CDATA[$F{total_iva_10}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="69" y="40" width="55" height="20" uuid="8b932eba-24ae-4e9a-8894-833c3489234b"/>
                <textFieldExpression><![CDATA[$F{liq_total_iva_5}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="150" y="40" width="90" height="20" uuid="15082b12-cae8-4fe8-acd0-27cdf1e50d0d"/>
                <textFieldExpression><![CDATA[$F{liq_total_iva_10}]]></textFieldExpression>
            </textField>
        </band>
    </detail>
</jasperReport>
